name: Electron ä¼ä¸šçº§å¤šç¯å¢ƒæ„å»ºä¸å‘å¸ƒæµæ°´çº¿ï¼ˆTag é©±åŠ¨ï¼‰

permissions:
  contents: write

on:
  push:
    tags:
      - "test-v*"
      - "pre-v*"
      - "v*"

jobs:
  build:
    name: æ„å»º Windows å®‰è£…åŒ…
    runs-on: windows-latest

    outputs:
      env: ${{ steps.env_detect.outputs.env }}
      version: ${{ steps.env_detect.outputs.version }}
      build_time: ${{ steps.time.outputs.time }}

    steps:
      - name: æ£€å‡ºä»£ç ä»“åº“
        uses: actions/checkout@v4

      - name: è¯†åˆ«å‘å¸ƒç¯å¢ƒä¸ç‰ˆæœ¬å·
        id: env_detect
        shell: bash
        run: |
          TAG="${GITHUB_REF#refs/tags/}"

          if [[ "$TAG" == test-* ]]; then
            ENV="test"
            VERSION="${TAG#test-}"
          elif [[ "$TAG" == pre-* ]]; then
            ENV="pre"
            VERSION="${TAG#pre-}"
          else
            ENV="production"
            VERSION="$TAG"
          fi

          echo "env=$ENV" >> $GITHUB_OUTPUT
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: è·å–æ„å»ºæ—¶é—´
        id: time
        shell: bash
        run: |
          echo "time=$(date '+%Y-%m-%d %H:%M:%S')" >> $GITHUB_OUTPUT

      - name: å®‰è£… Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "24"
          cache: "npm"

      - name: å®‰è£…é¡¹ç›®ä¾èµ–
        run: npm install

      - name: æ„å»º Windows åº”ç”¨ï¼ˆMSIï¼‰
        run: npm run build:win --mode ${{ steps.env_detect.outputs.env }}

      - name: æ•´ç†æ„å»ºäº§ç‰©ï¼ˆç¯å¢ƒéš”ç¦»ï¼‰
        shell: bash
        run: |
          mkdir -p artifacts/${{ steps.env_detect.outputs.env }}
          cp dist/**/*.msi artifacts/${{ steps.env_detect.outputs.env }}/

      - name: ä»…ä¸Šä¼ å½“å‰ç¯å¢ƒ MSI
        uses: actions/upload-artifact@v4
        with:
          name: windows-msi-${{ steps.env_detect.outputs.env }}
          path: |
            artifacts/${{ steps.env_detect.outputs.env }}/*.msi

  release:
    name: åˆ›å»ºæˆ–æ›´æ–° Release
    needs: build
    runs-on: ubuntu-latest

    steps:
      - name: ä¸‹è½½å½“å‰ç¯å¢ƒæ„å»ºäº§ç‰©
        uses: actions/download-artifact@v4
        with:
          name: windows-msi-${{ needs.build.outputs.env }}
          path: dist/

      - name: åˆ é™¤åŒå Releaseï¼ˆå¦‚æœå­˜åœ¨ï¼‰
        uses: dev-drprasad/delete-tag-and-release@v1.1
        with:
          tag_name: ${{ github.ref_name }}
          delete_release: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: åˆ›å»º GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          name: |
            ${{ needs.build.outputs.env == 'test' && 'ğŸ§ª æµ‹è¯•ç‰ˆ' || needs.build.outputs.env == 'pre' && 'ğŸš¦ é¢„å‘ç‰ˆ' || 'ğŸš€ æ­£å¼ç‰ˆ' }} - ${{ needs.build.outputs.version }}

          body: |
            ç¯å¢ƒï¼š${{ needs.build.outputs.env }}
            ç‰ˆæœ¬ï¼š${{ needs.build.outputs.version }}
            æ„å»ºæ—¶é—´ï¼š${{ needs.build.outputs.build_time }}

          prerelease: ${{ needs.build.outputs.env != 'production' }}

          files: |
            dist/*.msi

          fail_on_unmatched_files: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
